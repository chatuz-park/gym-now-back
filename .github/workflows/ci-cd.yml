name: Docker Compose Integration Test

on:
  push:
    branches: [ "main" ]

jobs:
  integration-test:
    runs-on: self-hosted

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      # 1. Limpieza Preventiva
      # En self-hosted, a veces quedan contenedores "zombis" de ejecuciones fallidas.
      # Esto asegura que los puertos 8080 no estén ocupados antes de empezar.
      - name: Limpiar entorno previo
        run: docker compose down --remove-orphans || true

      # 2. Levantar servicios
      # Usamos '-d' (detach) para que corran en segundo plano y el pipeline continúe
      # '--build' asegura que se reconstruya la imagen con los cambios recientes
      - name: Levantar Docker Compose
        run: docker compose up -d --build

      # 3. Esperar a que los servicios estén listos
      # A veces la DB tarda unos segundos en arrancar. Un sleep simple suele bastar para demos,
      # pero para producción es mejor usar scripts de "wait-for-it".
      - name: Esperar inicialización
        run: sleep 10

      # 4. Ejecutar pruebas
      # Opción A: Ejecutar un comando DENTRO del contenedor de la app
      # Esto es útil si tus tests unitarios/integración viven dentro del código de la app.
      - name: Correr tests dentro del contenedor
        run: docker compose exec -T app npm test
        # Nota: '-T' es necesario para evitar el error "the input device is not a TTY"

      # Opción B: Probar desde fuera (Blackbox testing)
      # Útil para verificar que el puerto responde.
      - name: Verificar respuesta HTTP
        run: curl --fail http://localhost:8080 || exit 1

      # 5. Logs (Solo si falla)
      # Si algo sale mal, queremos ver qué pasó antes de destruir todo.
      - name: Mostrar logs si hubo error
        if: failure()
        run: docker compose logs

      # 6. Limpieza Final (CRÍTICO)
      # 'always()' asegura que esto corra aunque los tests fallen.
      # Si no haces esto, el puerto 8080 quedará ocupado y el próximo push fallará.
      - name: Apagar y limpiar
        if: always()
        run: docker compose down --rmi local --volumes