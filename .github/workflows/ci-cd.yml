name: GymNow API CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    name: Build, Run & Test
    runs-on: self-hosted  # Tu runner configurado

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      # 1. Crear archivo .env dinámicamente
      # Docker Compose necesita este archivo para arrancar
      - name: Generar .env file
        run: |
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "DEBUG=True" >> .env
          echo "ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0" >> .env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_HOST=db" >> .env  # Importante: nombre del servicio en docker-compose
          echo "DB_PORT=5432" >> .env
          echo "JWT_ACCESS_TOKEN_LIFETIME=60" >> .env
          echo "JWT_REFRESH_TOKEN_LIFETIME=1440" >> .env

      # 2. Limpieza preventiva
      # Asegura que no haya contenedores viejos ocupando puertos
      - name: Limpiar entorno previo
        run: docker compose down -v --remove-orphans || true

      # 3. Construir y Levantar
      - name: Build y Levantar Servicios
        run: docker compose up -d --build

      # 4. Esperar a la base de datos
      # A veces Postgres tarda unos segundos en aceptar conexiones
      - name: Esperar a DB
        run: sleep 10

      # 5. Ejecutar Migraciones (Paso 5 del README)
      - name: Aplicar Migraciones
        run: docker compose exec -T api python manage.py migrate

      # 6. Poblar datos iniciales (Paso 6 del README)
      # Esto verifica que el seeder funcione correctamente
      - name: Seed Data
        run: docker compose exec -T api python manage.py seed_data

      # 7. Verificar que el servidor responde (Smoke Test)
      # Hacemos una petición al Swagger para ver si devuelve 200 OK
      - name: Verificar Swagger UI
        run: |
          sleep 5
          curl --fail http://localhost:8000/swagger/ || exit 1
          echo "¡El API se levantó correctamente y la documentación está accesible!"

      # 8. Ejecutar Tests (Opcional pero recomendado)
      # docker compose exec -T api python manage.py test

      # 9. Limpieza Final
      # Si quieres que el API siga corriendo en tu servidor después del pipeline,
      # elimina o comenta este paso. Si es solo para probar (CI), déjalo.
      # - name: Apagar servicios (Cleanup)
      #   if: always()
      #   run: docker compose down -v